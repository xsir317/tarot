# 额度策略

## 概述

本节说明用户额度管理策略，包括免费额度、订阅额度和付费额度。

---

## 免费额度策略

### 未登录用户（匿名）

| 项目 | 说明 |
|------|------|
| 免费额度 | 3 次 |
| 有效期 | 7 天 |
| 识别方式 | 设备指纹 + IP + localStorage |
| 存储位置 | Redis |

### 已登录用户

| 项目 | 说明 |
|------|------|
| 免费额度 | 3 次/周 |
| 重置时间 | 每周一 00:00 |
| 存储位置 | PostgreSQL (user_quotas 表) |

---

## 包月订阅额度

| 项目 | 说明 |
|------|------|
| 价格 | $9.99 / 月 |
| 每日限制 | 200 次 |
| 每周限制 | 700 次 |
| 重置时间 | 每日 00:00 重置日限额 |

---

## 额度检查流程

```
[请求占卜]
  ↓
[检查用户类型]
  ├─→ 匿名用户
  │     ↓
  │   [检查匿名额度]
  │     ├─→ 有额度 → [扣减] → [允许]
  │     └─→ 无额度 → [引导注册/付费]
  │
  └─→ 已登录用户
        ↓
      [检查订阅状态]
        ├─→ 有订阅
        │     ↓
        │   [检查订阅额度]
        │     ├─→ 有额度 → [扣减] → [允许]
        │     └─→ 无额度 → [提示超限]
        │
        └─→ 无订阅
              ↓
            [检查免费额度]
              ├─→ 有额度 → [扣减] → [允许]
              └─→ 无额度 → [引导付费]
```

---

## 数据库表结构

### user_quotas 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 额度 ID |
| user_id | UUID | 用户 ID |
| remaining | INT | 剩余次数（每周重置为 3） |
| total | INT | 总次数（3） |
| week_start | DATE | 本周起始日期（周一） |

### subscription_usage 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 记录 ID |
| subscription_id | UUID | 订阅 ID |
| usage_date | DATE | 使用日期 |
| daily_used | INT | 当日已使用次数（每日重置） |
| week_start | DATE | 本周起始日期倒 |
| weekly_used | INT | 本周已使用次数 |

---

## 错误代码

| 错误代码 | 描述 |
|---------|------|
| QUOTA_001 | 免费额度已用完 |
| QUOTA_002 | 订阅额度已超限 |
| QUOTA_003 | 设备指纹无效 |
