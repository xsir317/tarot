# 产品需求文档 (PRD)

## 版本信息
- 版本: MVP v1.0
- 状态: 规划中
- 更新日期: 2026-02-04

---

## 功能清单

### P0 - 核心功能（MVP 必须实现）

| 功能 ID | 功能名称 | 优先级 | 状态 | 验收标准 |
|---------|---------|-------|------|---------|
| F-001 | 问题输入 | P0 | 待开发 | 用户可输入多行问题，可选选择性别 |
| F-002 | 问题过滤 | P0 | 待开发 | LLM 判断问题是否适合占卜，不适合则给出引导 |
| F-003 | 随机抽牌 | P0 | 待开发 | 随机抽取 3 张牌，每张随机正/倒位 |
| F-004 | 洗牌动画 | P0 | 待开发 | 展示洗牌动画效果 |
| F-005 | 抽牌动画 | P0 | 待开发 | 展示抽牌动画效果 |
| F-006 | 翻牌互动 | P0 | 待开发 | 用户依次点击翻转 3 张牌背 |
| F-007 | 逐张解读 | P0 | 待开发 | 翻牌后展示每张牌的解读 |
| F-008 | 整体解读 | P0 | 待开发 | 翻完 3 张牌后展示整体解读 |
| F-009 | 免费额度管理 | P0 | 待开发 | 未登录 3 次，已登录每周 3 次 |
| F-010 | 匿名用户额度 | P0 | 待开发 | 设备指纹 + IP + localStorage 识别 |
| F-011 | 用户注册 | P0 | 待开发 | 手机号/邮箱二选一，验证码注册 |
| F-012 | 按次付费 | P0 | 待开发 | 0.99-1.99 美元/次 |
| F-013 | 包月订阅 | P0 | 待开发 | 9.99 美元/月，每日 200 次，每周 700 次 |

### P1 - 重要功能（MVP 目标）

| 功能 ID | 功能名称 | 优先级 | 状态 | 验收标准 |
|---------|---------|-------|------|---------|
| F-014 | 历史记录 | P1 | 待开发 | 保留最近 6 个月的占卜记录 |
| F-015 | 多语言支持 | P1 | 待开发 | 支持中英文，自动检测或手动选择 |
| F-016 | 用户中心 | P1 | 待开发 | 查看剩余次数、订阅状态、历史记录 |
| F-017 | 捐赠功能 | P1 | 待开发 | 用户满意后自愿打赏 |

### P2 - 优化功能（后续迭代）

| 功能 ID | 功能名称 | 优先级 | 状态 | 验收标准 |
|---------|---------|-------|------|---------|
| F-018 | 分享功能 | P2 | 待开发 | 分享占卜结果到社交媒体 |
| F-019 | 深色模式 | P2 | 待开发 | 支持深色/浅色主题切换 |

---

## 功能依赖关系

```
F-001 (问题输入)
  → F-002 (问题过滤)
    → F-003 (随机抽牌)
      → F-004 (洗牌动画)
        → F-005 (抽牌动画)
          → F-006 (翻牌互动)
            → F-007 (逐张解读)
              → F-008 (整体解读)

F-009 (免费额度管理)
  ├─→ F-010 (匿名用户额度)
  └─→ F-011 (用户注册)
       ├─→ F-012 (按次付费)
       └─→ F-013 (包月订阅)

F-015 (多语言支持)
  → 影响所有解读相关的功能

F-016 (用户中心)
  → 依赖 F-009 (免费额度管理)
```

---

## 非功能需求

### 性能
- 页面首屏加载时间 < 2 秒
- LLM 响应时间 < 5 秒
- API 响应时间 < 500 ms（不含 LLM）

### 安全
- 用户密码 bcrypt 加密
- JWT token 有效期合理设置
- HTTP-only Cookies 防止 XSS
- 敏感信息环境变量管理
- LLM 输入过滤，防止 prompt 注入

### 可用性
- 支持主流浏览器（Chrome、Safari、Firefox、Edge）
- 支持移动端响应式布局
- 网络错误友好提示

### 可维护性
- 代码测试覆盖率：核心逻辑 100%，API > 90%
- 遵循 TDD 开发流程
- 代码风格统一（Ruff、ESLint）

---

## 验收检查清单

### 功能验收
- [ ] 用户可以完成一次完整的占卜流程
- [ ] 问题过滤正确识别不适合的问题
- [ ] 洗牌和抽牌动画流畅
- [ ] 翻牌互动正常，逐张解读正确展示
- [ ] 免费额度正确扣减
- [ ] 注册流程正常
- [ ] 支付流程正常

### 测试验收
- [ ] 所有单元测试通过
- [ ] 测试覆盖率达标
- [ ] E2E 测试关键流程通过

### 部署验收
- [ ] Docker Compose 本地运行正常
- [ ] 数据库迁移正常
- [ ] Redis 连接正常

---

## 风险与依赖

### 技术风险
| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| LLM 成本超预算 | 中 | 优化 prompt，限制输出长度，监控 token 使用 |
| 设备指纹可靠性 | 中 | 组合使用 IP + localStorage + 浏览器指纹 |
| 支付渠道限制 | 低 | 使用 Stripe，支持多地区支付 |

### 外部依赖
- OpenAI/Anthropic API
- Stripe API
- 邮件服务（SendGrid/AWS SES）
- 短信服务
