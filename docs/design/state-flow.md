# 状态流转图

## 用户状态

### 匿名用户状态

```
[未访问]
  ↓
[已访问] - 3次免费额度
  ↓ 额度用完
[需注册或付费]
  ├─→ [注册中] - 手机号/邮箱验证
  │     ↓ 注册成功
  │   [已注册用户]
  │
  └─→ [付费中] - 按次付费或包月
        ↓ 支付成功
      [付费用户]
```

---

## 订单状态

### Stripe Payment Intent 状态

```
[pending] - 待支付
  ↓
[processing] - 处理中
  ├─→ [succeeded] - 支付成功
  └─→ [failed] - 支付失败
       ↓
     [canceled] - 已取消
```

### Stripe Subscription 状态

```
[active] - 活跃中
  ├─→ [past_due] - 逾期未支付
  │     ↓
  │   [canceled] - 已取消
  │
  └─→ [canceled_at_period_end] - 周期结束后取消
```

---

## 占卜流程状态

```
[开始]
  ↓
[问题输入]
  ↓
[问题验证]
  ├─→ [不适合] → 显示引导 → 返回问题输入
  └─→ [适合]
       ↓
     [洗牌动画]
       ↓
     [抽牌动画]
       ↓
     [翻牌互动]
       ├─→ 第1张牌 → 显示解读
       ├─→ 第2张牌 → 显示解读
       └─→ 第3张牌 → 显示解读 → 显示整体解读
            ↓
          [完成]
```

---

## 额度扣减状态

```
[检查额度]
  ├─→ [免费额度充足]
  │     ↓
  │   [扣减免费额度]
  │     ↓
  │   [成功]
  │
  ├─→ [订阅额度充足]
  │     ↓
  │   [扣减订阅额度]
  │     ↓
  │   [成功]
  │
  └─→ [额度不足]
        ↓
      [引导付费]
```

---

## 认证状态

```
[未登录]
  ↓
[登录请求]
  ↓
[密码验证]
  ├─→ 成功 → [已登录]
  └─→ 失败 → 返回登录

[已登录]
  ├─→ [访问受限资源] → 检查 Token
  │     ├─→ 有效 → 允许访问
  │     └─→ 过期 → 刷新 Token 或重新登录
  │
  └─→ [登出] → [未登录]
```

---

## Token 状态

```
[access_token]
  ├─→ 有效 (15分钟)
  └─→ 过期 → 使用 refresh_token
        ↓
      [refresh_token]
        ├─→ 有效 (7天) → 生成新 access_token
        └─→ 过期 → 重新登录
```
